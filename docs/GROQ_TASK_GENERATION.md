# Quick To-Do Generated by Groq - Implementation Guide

## Overview
This guide explains how to use the Groq-integrated task generation system in NueraCare. The system generates personalized daily tasks based on user health data and saves them to Sanity DB.

## Architecture

```
┌─────────────────────────┐
│   Frontend (Expo)       │
│   - home.tsx            │
│   - Displays tasks      │
│   - Mark done           │
└────────┬────────────────┘
         │ API Call
         ▼
┌─────────────────────────┐
│   Backend (FastAPI)     │
│   - tasks.py router     │
│   - Groq Integration    │
│   - Task Generation     │
└────────┬────────────────┘
         │ Returns Tasks
         ▼
┌─────────────────────────┐
│   Sanity Database       │
│   - dailyTask type      │
│   - Store/Update tasks  │
│   - Track completion    │
└─────────────────────────┘
```

## Components Created

### 1. Sanity Schema: `dailyTask`
**Location:** `nueracare-expo-app/sanity/schemaTypes/dailyTask.ts`

Fields:
- `clerkId` (string, required) - User ID from Clerk auth
- `title` (string, required) - Task title (max 200 chars)
- `description` (text, optional) - Full task description
- `isCompleted` (boolean) - Completion status
- `priority` (string) - low, medium, high
- `category` (string) - medication, exercise, appointment, health-check, nutrition, general
- `dueDate` (datetime) - When task is due
- `completedAt` (datetime) - When task was marked done
- `generatedByGroq` (boolean) - Whether Groq generated it
- `createdAt` (datetime) - Task creation timestamp
- `updatedAt` (datetime) - Last update timestamp

### 2. Backend Tasks Router
**Location:** `backend/routers/tasks.py`

Endpoints:
- `POST /api/tasks/generate-groq` - Generate tasks using Groq AI
  - Request body: `{ clerkId, userHealthData }`
  - Returns: List of generated tasks ready to save

Features:
- Integrates with Groq AI API
- Personalizes tasks based on:
  - Health conditions
  - Current medications
  - Allergies
  - Weight, age, blood pressure, blood sugar
  - Activity level
- Falls back to default tasks if Groq fails
- Returns JSON-ready for Sanity

### 3. Sanity Service Functions
**Location:** `nueracare-expo-app/services/sanity.ts`

New functions:
```typescript
// Get today's tasks
getTodaysTasks(clerkId: string): Promise<DailyTask[]>

// Get all pending tasks
getPendingTasks(clerkId: string): Promise<DailyTask[]>

// Create single task
createTask(clerkId, taskData): Promise<DailyTask>

// Create multiple tasks (for Groq generation)
createMultipleTasks(clerkId, tasks): Promise<DailyTask[]>

// Mark task as done (saves to DB)
markTaskAsDone(taskId: string): Promise<void>

// Mark task as not done
markTaskAsNotDone(taskId: string): Promise<void>

// Update task
updateTask(taskId, updates): Promise<void>

// Delete task
deleteTask(taskId: string): Promise<void>
```

### 4. Frontend Home Page Integration
**Location:** `nueracare-expo-app/app/(tabs)/home.tsx`

Features:
- Loads today's incomplete tasks on screen focus
- Displays top 3 tasks in "Today's Focus" section
- Shows task category, priority, and due date
- Color-coded priority indicators (red=high, orange=medium, green=low)
- "Mark done" button that saves to Sanity immediately
- Empty state message when no tasks
- Loading indicator while fetching
- Link to "View all tasks" for full task list

UI Components:
- Task cards with title and category
- Priority indicator bullets
- Mark done buttons with loading state
- Empty state with checkmark icon

## Usage Guide

### 1. Generate Tasks (One-Time or Daily)

#### Option A: On App Launch
```typescript
// In useEffect on first screen load
import { generateGroqTasks, generateAndSaveGroqTasks } from '@/utils/groqTaskGenerator';
import { getUserProfile } from '@/services/sanity';
import { createMultipleTasks } from '@/services/sanity';

const generateDailyTasks = async (clerkId: string) => {
  try {
    // Get user health data from Sanity
    const userProfile = await getUserProfile(clerkId);
    
    // Generate tasks using Groq
    const tasks = await generateGroqTasks(clerkId, {
      firstName: userProfile?.firstName,
      age: userProfile?.age,
      weight: userProfile?.weight,
      bloodPressure: userProfile?.bloodPressure,
      conditions: userProfile?.healthConditions,
      medications: userProfile?.medications,
      allergies: userProfile?.allergies,
      activityLevel: userProfile?.activityLevel,
    });
    
    // Save to Sanity
    await createMultipleTasks(clerkId, tasks);
    
    // Refresh tasks on home screen
    loadTasks();
  } catch (error) {
    console.error("Error generating daily tasks:", error);
  }
};
```

#### Option B: On Button Click (User-Triggered)
```typescript
<TouchableOpacity
  style={styles.generateTasksButton}
  onPress={() => generateDailyTasks(user.id)}
>
  <Text style={styles.buttonText}>Generate Today's Tasks</Text>
</TouchableOpacity>
```

#### Option C: Scheduled (Using Background Task)
```typescript
// Set up task scheduling with expo-task-manager
import * as TaskManager from 'expo-task-manager';

TaskManager.defineTask('GENERATE_DAILY_TASKS', async () => {
  try {
    // This runs at a scheduled time
    const clerkId = await getUserClerkId();
    await generateDailyTasks(clerkId);
  } catch (error) {
    console.error("Scheduled task error:", error);
  }
  return TaskManager.BackgroundFetchResult.NewData;
});
```

### 2. Display Tasks
Tasks are automatically loaded and displayed on the home screen:
- Load on screen focus using `useFocusEffect`
- Show top 3 incomplete tasks
- Automatically update when marking done
- Pull-to-refresh to reload

### 3. Mark Tasks as Done
```typescript
// Automatic when button is tapped
const handleMarkDone = async (taskId: string) => {
  try {
    await markTaskAsDone(taskId);
    // UI updates automatically
  } catch (error) {
    Alert.alert("Error", "Failed to mark task as done");
  }
};
```

### 4. View All Tasks
Navigate to dedicated tasks screen:
```typescript
<TouchableOpacity onPress={() => router.push("/tasks/today")}>
  <Text>View all tasks →</Text>
</TouchableOpacity>
```

## Backend Setup

### Required Environment Variables
Add to `.env` file in backend:
```
GROQ_API_KEY=your_groq_api_key_here
```

### Get Groq API Key
1. Sign up at https://console.groq.com
2. Create new API key
3. Set in environment variable
4. Default model: `mixtral-8x7b-32768`

## Testing the Integration

### 1. Test Backend Endpoint
```bash
curl -X POST http://localhost:8000/api/tasks/generate-groq \
  -H "Content-Type: application/json" \
  -d '{
    "clerkId": "user_123",
    "userHealthData": {
      "firstName": "John",
      "age": 45,
      "conditions": ["diabetes", "hypertension"],
      "medications": ["Metformin", "Lisinopril"],
      "weight": 85,
      "bloodPressure": "140/90",
      "activityLevel": "moderate"
    }
  }'
```

Expected response:
```json
{
  "tasks": [
    {
      "title": "Take Metformin",
      "description": "Take 500mg with breakfast",
      "priority": "high",
      "category": "medication",
      "clerkId": "user_123",
      "isCompleted": false,
      "generatedByGroq": true,
      "dueDate": "2024-02-04T08:00:00Z"
    },
    ...
  ],
  "message": "Generated 5 personalized tasks using Groq AI"
}
```

### 2. Test Frontend Integration
1. Go to home screen
2. Verify tasks load from Sanity
3. Tap "Mark done" button
4. Verify task disappears from list
5. Check Sanity dashboard - task should have `isCompleted: true`

### 3. Verify Sanity Database
1. Go to Sanity Studio
2. Navigate to "Daily Task" documents
3. Check:
   - Tasks created with correct clerkId
   - `isCompleted` toggles when marked done
   - `completedAt` timestamp appears
   - `generatedByGroq` is true for AI tasks

## Customization

### Change Task Generation Prompt
Edit the prompt in `backend/routers/tasks.py`:
```python
prompt = f"""{profile_text}

[Your custom prompt here]

Return the tasks in this exact JSON format...
"""
```

### Change Number of Generated Tasks
In `backend/routers/tasks.py`, change from 5 to desired number:
```python
prompt = "...generate exactly 10 personalized daily health tasks..."
```

### Change Display Count on Home
In `nueracare-expo-app/app/(tabs)/home.tsx`:
```typescript
// Change from 3 to desired number
const todaysTasks = await getTodaysTasks(user.id);
setTasks(todaysTasks.filter(task => !task.isCompleted).slice(0, 5));
```

### Change Task Categories
Update in `dailyTask` schema and function type definitions:
```typescript
category: 'medication' | 'exercise' | 'custom' | ...
```

## Troubleshooting

### Tasks Not Loading
1. Check Sanity connection - verify `EXPO_PUBLIC_SANITY_PROJECT_ID` is set
2. Check clerkId - ensure user is authenticated
3. Check Sanity schema - verify `dailyTask` type exists
4. Check network - verify backend is running

### Groq Generation Failing
1. Check `GROQ_API_KEY` is set in backend `.env`
2. Check API key is valid - test in Groq console
3. Check rate limits - Groq has usage quotas
4. Fall back to default tasks (automatic if Groq fails)

### Tasks Not Saving
1. Check Sanity token - verify `EXPO_PUBLIC_SANITY_TOKEN` allows write
2. Check permissions - user must have doc creation permission
3. Check network - verify connection to Sanity API
4. Check errors - look at console logs for error details

### Mark Done Not Working
1. Verify clerkId - check that task belongs to current user
2. Check Sanity permissions - write permission required
3. Verify task ID - ensure it exists in database
4. Check for conflicts - verify no race conditions

## Future Enhancements

1. **Recurring Tasks**
   - Create repeating daily/weekly tasks
   - Auto-generate based on schedules

2. **Smart Scheduling**
   - Optimal task timing based on user routine
   - Medication timing based on interactions

3. **Analytics**
   - Track completion rates
   - Identify compliance patterns
   - Dashboard showing trends

4. **AI Recommendations**
   - Adjust tasks based on user compliance
   - Suggest new health goals
   - Learn user preferences

5. **Notifications**
   - Push notifications for task reminders
   - Custom reminder times
   - Recurring task alerts

6. **Integration**
   - Sync with calendar apps
   - Share with caregivers
   - Export task history

## Support

For issues or questions:
1. Check Sanity dashboard for data integrity
2. Review backend logs for Groq errors
3. Check frontend console for network errors
4. Verify environment variables are set
5. Test endpoint directly with curl

## Summary

The Groq task generation system provides:
- ✅ Personalized daily tasks based on health data
- ✅ End-to-end Sanity integration
- ✅ Mark done functionality with DB persistence
- ✅ Automatic loading on home screen
- ✅ Fallback to default tasks if Groq unavailable
- ✅ Type-safe with TypeScript
- ✅ Fully accessible UI
- ✅ Error handling and loading states
