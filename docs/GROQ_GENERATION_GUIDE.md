# Groq AI Task Generation Guide

## Overview

The NueraCare app uses **Groq AI** to automatically generate 3 personalized daily health tasks based on user health data. This guide explains how it works and how to test it.

## How It Works

### Auto-Generation Flow

1. **App Loads** â†’ Home screen mounts
2. **Check Tasks** â†’ Fetches today's tasks from backend
3. **No Tasks?** â†’ If empty, triggers auto-generation
4. **Groq API Call** â†’ Backend sends health data to Groq
5. **AI Generation** â†’ Groq generates 3 personalized tasks
6. **Save to Sanity** â†’ Tasks stored in database
7. **Display** â†’ Frontend shows generated tasks

### Request Flow Diagram

```
Frontend (home.tsx)
  â†“
loadTasks() 
  â†“
GET /api/tasks/today/{clerk_id}
  â†“
Backend checks if empty
  â†“
If empty â†’ autoGenerateGroqTasks()
  â†“
POST /api/tasks/generate-groq
  â†“
Groq API (mixtral-8x7b-32768)
  â†“
Returns 3 task JSON
  â†“
Save to Sanity
  â†“
Return formatted response
  â†“
Frontend displays tasks
```

## Backend Endpoint

### Generate Tasks with Groq

**Endpoint:** `POST /api/tasks/generate-groq`

**Request Body:**
```json
{
  "clerkId": "user_clerk_id_here",
  "userHealthData": {
    "age": 45,
    "firstName": "John",
    "conditions": ["diabetes", "hypertension"],
    "medications": ["Metformin", "Lisinopril"],
    "allergies": ["Penicillin"],
    "bloodPressure": "130/85",
    "bloodSugar": 150,
    "weight": 85,
    "activityLevel": "moderate"
  }
}
```

**Response (200 OK):**
```json
{
  "tasks": [
    {
      "title": "Check blood sugar levels",
      "description": "Monitor blood sugar with glucometer before breakfast",
      "category": "health-check",
      "priority": "high",
      "clerkId": "user_clerk_id_here",
      "isCompleted": false,
      "generatedByGroq": true,
      "dueDate": "2026-02-04T10:30:00"
    },
    {
      "title": "Take prescribed medications",
      "description": "Take Metformin and Lisinopril with meals",
      "category": "medication",
      "priority": "high",
      "clerkId": "user_clerk_id_here",
      "isCompleted": false,
      "generatedByGroq": true,
      "dueDate": "2026-02-04T09:00:00"
    },
    {
      "title": "30-minute moderate exercise",
      "description": "Walk or light physical activity to manage diabetes",
      "category": "exercise",
      "priority": "medium",
      "clerkId": "user_clerk_id_here",
      "isCompleted": false,
      "generatedByGroq": true,
      "dueDate": "2026-02-04T17:00:00"
    }
  ],
  "message": "Generated 3 personalized tasks using Groq AI"
}
```

## Testing Groq Generation

### Option 1: Automated Test Script

**Run the test script:**
```bash
cd backend
python test_groq_generation.py "your_clerk_id"
```

**Example:**
```bash
python test_groq_generation.py "user_399lIslRMLqlOqSBEBkhty0kJEB"
```

**Output:**
```
======================================================================
ğŸ¤– TESTING GROQ TASK GENERATION
======================================================================

ğŸ“¤ Sending request to: http://localhost:8000/api/tasks/generate-groq
ğŸ‘¤ User ID: user_399lIslRMLqlOqSBEBkhty0kJEB
ğŸ“‹ Health Data:
   - age: 45
   - firstName: John
   - conditions: ['diabetes', 'hypertension']
   ...

ğŸ“Š Response Status: 200
======================================================================

âœ… SUCCESS! Generated 3 tasks

Message: Generated 3 personalized tasks using Groq AI

ğŸ“Œ Task 1:
   Title: Check blood sugar levels
   Description: Monitor blood sugar with glucometer before breakfast
   Category: health-check
   Priority: high
   Generated by Groq: True

...
```

### Option 2: Manual cURL Request

```bash
curl -X POST http://localhost:8000/api/tasks/generate-groq \
  -H "Content-Type: application/json" \
  -d '{
    "clerkId": "user_399lIslRMLqlOqSBEBkhty0kJEB",
    "userHealthData": {
      "age": 45,
      "firstName": "John",
      "conditions": ["diabetes"],
      "medications": ["Metformin"],
      "activityLevel": "moderate"
    }
  }'
```

### Option 3: Frontend Testing

1. **Clear today's tasks** in Sanity Studio
2. **Reload the app** - will auto-trigger Groq generation
3. **Check console logs:**
   - `ğŸ¤– No tasks found, generating Groq tasks...`
   - `ğŸš€ Calling Groq API...`
   - `âœ… Auto-generated and saved tasks to Sanity`
   - `ğŸ“‹ Displaying 3 generated tasks`

## Groq AI Configuration

### Model Used
- **Model:** `mixtral-8x7b-32768`
- **Max Tokens:** 1024
- **Temperature:** Default (0.7)

### Prompt Template

```
User Health Profile:
- Name: [if provided]
- Age: [if provided]
- Health Conditions: [conditions list]
- Current Medications: [medications list]
- Blood Pressure: [if provided]
- Blood Sugar: [if provided]
- Activity Level: [if provided]

Based on this health profile, generate exactly 3 personalized daily health tasks for today.

Return tasks in JSON format with:
- title: Task name
- description: Brief description
- priority: high|medium|low
- category: medication|exercise|appointment|health-check|nutrition|general

Generate EXACTLY 3 tasks. No more, no less.
```

## Logging & Debugging

### Backend Logs

When generating tasks, you'll see:

```
============================================================
ğŸš€ GROQ TASK GENERATION REQUEST
============================================================
ğŸ‘¤ User ID: user_399lIslRMLqlOqSBEBkhty0kJEB
ğŸ“‹ Health Data: {...}
============================================================

ğŸ¤– Calling Groq API with model: mixtral-8x7b-32768
ğŸ“ Prompt length: 456 characters
âœ… Groq API responded successfully
ğŸ“„ Response text length: 821 characters
âœ… Successfully parsed JSON with 3 tasks
  ğŸ“Œ Task 1: Check blood sugar levels (priority: high, category: health-check)
  ğŸ“Œ Task 2: Take prescribed medications (priority: high, category: medication)
  ğŸ“Œ Task 3: 30-minute moderate exercise (priority: medium, category: exercise)
ğŸ“Š Generated 3 tasks successfully

============================================================
âœ… GENERATION COMPLETE - 3 TASKS
============================================================
```

### Frontend Logs

When auto-generating, you'll see:

```
ğŸ¤– No tasks found, generating Groq tasks...
ğŸš€ Calling Groq API to generate tasks...
ğŸ“ Groq generated 3 tasks
ğŸ’¾ Saving generated tasks to Sanity...
âœ… Auto-generated and saved tasks to Sanity
ğŸ”„ Re-fetching tasks from Sanity...
ğŸ“‹ Displaying 3 generated tasks
```

## Environment Variables Required

**Backend (.env file):**
```
GROQ_API_KEY=your_groq_api_key_here
SANITY_PROJECT_ID=q5maqr3y
SANITY_DATASET=production
SANITY_API_TOKEN=your_sanity_api_token_here
```

**Frontend (.env.local):**
```
EXPO_PUBLIC_API_URL=http://localhost:8000
EXPO_PUBLIC_SANITY_PROJECT_ID=q5maqr3y
EXPO_PUBLIC_SANITY_DATASET=production
EXPO_PUBLIC_SANITY_TOKEN=your_sanity_api_token_here
```

## Troubleshooting

### Issue: "No Groq API Key"

**Error:** 
```
Failed to generate tasks: Error: GROQ_API_KEY environment variable is missing
```

**Solution:** 
- Set `GROQ_API_KEY` in `.env` file in backend directory
- Restart backend: `uvicorn main:app --reload`

### Issue: "Invalid JSON from Groq"

**Error:**
```
json.decoder.JSONDecodeError: Expecting value
```

**Solution:**
- Groq might be returning markdown code blocks
- Try restarting the request
- Check backend logs for response text

### Issue: "Tasks not saving to Sanity"

**Error:**
```
Failed to create tasks in Sanity
```

**Solution:**
- Verify `SANITY_API_TOKEN` has write access
- Check Sanity project ID and dataset name
- Ensure `dailyTask` schema is deployed

### Issue: "Auto-generation not triggering"

**Check:**
- Verify `tasksGeneratedToday` state in frontend
- Check if tasks already exist for the day
- Monitor console for error logs
- Ensure backend API is running on port 8000

## Performance Notes

- **Generation Time:** ~3-5 seconds (Groq API latency)
- **Caching:** Auto-generation only triggers once per session per user
- **Timeout:** 30 second timeout for Groq API call
- **Fallback:** If Groq fails, shows 3 default fallback tasks

## Example Health Conditions for Groq

The system handles various health conditions:
- Diabetes (type 1, type 2)
- Hypertension
- Heart disease
- Asthma
- COPD
- Arthritis
- Thyroid disorders
- Kidney disease
- And many more...

Tasks are personalized based on the conditions provided.

## File Locations

- **Backend Endpoint:** [backend/routers/tasks.py](../backend/routers/tasks.py#L308)
- **Frontend Trigger:** [nueracare-expo-app/app/(tabs)/home.tsx](../nueracare-expo-app/app/(tabs)/home.tsx#L160)
- **Test Script:** [backend/test_groq_generation.py](../backend/test_groq_generation.py)

## Next Steps

1. âœ… Test Groq generation with test script
2. âœ… Verify tasks appear in Sanity
3. âœ… Check frontend auto-generation trigger
4. âœ… Monitor logs for any errors
5. âœ… Adjust health data for personalization
6. âœ… Test with different user conditions
